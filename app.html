<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Modeler Standalone</title>
    
    <!-- Security check -->
    <script>
        if (!sessionStorage.getItem('authenticated')) {
            window.location.href = 'index.html';
        }
    </script>
    
    <!-- BPMN.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.9.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.9.0/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.9.0/dist/assets/bpmn-font/css/bpmn-embedded.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .toolbar {
            background: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #f5f5f5;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        #canvas {
            flex: 1;
            background: white;
            position: relative;
        }
        
        .status-bar {
            background: #333;
            color: white;
            padding: 0.5rem 1.5rem;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-label:hover {
            background: #f5f5f5;
        }
        
        .separator {
            width: 1px;
            height: 24px;
            background: #ddd;
            margin: 0 0.5rem;
        }
        
        .logout-btn {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß BPMN Modeler Standalone</h1>
        <button class="btn logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="toolbar">
        <button class="btn btn-primary" onclick="createNewDiagram()">
            <span>üìÑ</span> New Diagram
        </button>
        
        <label for="file-input" class="file-label">
            <span>üìÇ</span> Open BPMN File
        </label>
        <input type="file" id="file-input" accept=".bpmn,.xml" onchange="openFile(event)">
        
        <button class="btn btn-secondary" onclick="saveDiagram()">
            <span>üíæ</span> Download BPMN
        </button>
        
        <button class="btn btn-secondary" onclick="exportSVG()">
            <span>üñºÔ∏è</span> Export as SVG
        </button>
        
        <div class="separator"></div>
        
        <button class="btn btn-secondary" onclick="zoomIn()">
            <span>üîç</span> Zoom In
        </button>
        
        <button class="btn btn-secondary" onclick="zoomOut()">
            <span>üîç</span> Zoom Out
        </button>
        
        <button class="btn btn-secondary" onclick="zoomReset()">
            <span>üéØ</span> Fit to View
        </button>
        
        <div class="separator"></div>
        
        <button class="btn btn-danger" onclick="clearDiagram()">
            <span>üóëÔ∏è</span> Clear
        </button>
    </div>
    
    <div id="canvas"></div>
    
    <div class="status-bar">
        <span id="status">Ready</span>
        <span id="element-count">Elements: 0</span>
    </div>
    
    <!-- BPMN.js -->
    <script src="https://unpkg.com/bpmn-js@17.9.0/dist/bpmn-modeler.production.min.js"></script>
    
    <script>
        // Initialize BPMN Modeler
        let modeler;
        
        function initModeler() {
            modeler = new BpmnJS({
                container: '#canvas',
                keyboard: {
                    bindTo: window
                },
                propertiesPanel: {
                    parent: '#properties'
                }
            });
            
            // Add event listeners
            modeler.on('commandStack.changed', updateStatus);
            modeler.on('element.changed', updateElementCount);
            
            // Create initial diagram
            createNewDiagram();
        }
        
        // Create new diagram
        function createNewDiagram() {
            const defaultDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI" 
                  id="Definitions_1" 
                  targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="Start">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:task id="Task_1" name="Task">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
    </bpmn:task>
    <bpmn:endEvent id="EndEvent_1" name="End">
      <bpmn:incoming>Flow_2</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1" />
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="EndEvent_1" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="170" y="100" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="260" y="78" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="420" y="100" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="206" y="118" />
        <di:waypoint x="260" y="118" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="360" y="118" />
        <di:waypoint x="420" y="118" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
            
            modeler.importXML(defaultDiagram).then(() => {
                zoomReset();
                updateStatus('New diagram created');
            }).catch(err => {
                console.error('Error creating diagram:', err);
                updateStatus('Error creating diagram');
            });
        }
        
        // Open file
        function openFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const xml = e.target.result;
                modeler.importXML(xml).then(() => {
                    zoomReset();
                    updateStatus(`Opened: ${file.name}`);
                }).catch(err => {
                    console.error('Error opening file:', err);
                    updateStatus('Error opening file');
                });
            };
            reader.readAsText(file);
        }
        
        // Save diagram
        async function saveDiagram() {
            try {
                const { xml } = await modeler.saveXML({ format: true });
                const blob = new Blob([xml], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'diagram.bpmn';
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('Diagram saved');
            } catch (err) {
                console.error('Error saving diagram:', err);
                updateStatus('Error saving diagram');
            }
        }
        
        // Export as SVG
        async function exportSVG() {
            try {
                const { svg } = await modeler.saveSVG();
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('Exported as SVG');
            } catch (err) {
                console.error('Error exporting SVG:', err);
                updateStatus('Error exporting SVG');
            }
        }
        
        // Clear diagram
        function clearDiagram() {
            if (confirm('Are you sure you want to clear the diagram? This cannot be undone.')) {
                modeler.clear();
                updateStatus('Diagram cleared');
                updateElementCount();
            }
        }
        
        // Zoom controls
        function zoomIn() {
            const canvas = modeler.get('canvas');
            const zoom = canvas.zoom();
            canvas.zoom(zoom * 1.2);
        }
        
        function zoomOut() {
            const canvas = modeler.get('canvas');
            const zoom = canvas.zoom();
            canvas.zoom(zoom * 0.8);
        }
        
        function zoomReset() {
            const canvas = modeler.get('canvas');
            canvas.zoom('fit-viewport');
        }
        
        // Update status
        function updateStatus(message) {
            if (message) {
                document.getElementById('status').textContent = message;
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready';
                }, 3000);
            }
        }
        
        // Update element count
        function updateElementCount() {
            const elementRegistry = modeler.get('elementRegistry');
            const elements = elementRegistry.filter(element => element.type !== 'label');
            document.getElementById('element-count').textContent = `Elements: ${elements.length}`;
        }
        
        // Logout
        function logout() {
            sessionStorage.removeItem('authenticated');
            window.location.href = 'index.html';
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveDiagram();
                        break;
                    case 'o':
                        e.preventDefault();
                        document.getElementById('file-input').click();
                        break;
                    case 'n':
                        e.preventDefault();
                        createNewDiagram();
                        break;
                }
            }
        });
        
        // Initialize on load
        window.onload = initModeler;
    </script>
</body>
</html>
